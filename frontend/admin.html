<!DOCTYPE html>
<html lang="ms">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - FAQ Manager</title>
    <link rel="stylesheet" href="adminstyle.css" />
</head>

<body>
    <div class="admin-container">
        <!-- Header Section -->
        <div class="admin-header">
            <div class="header-top">
                <div>
                    <h2>FAQ Manager</h2>
                    <div id="statusIndicator">Memuat FAQ...</div>
                </div>
                <button id="newFaqBtn" class="btn primary">‚ú® Soalan Baharu</button>
            </div>
            <div class="toolbar">
                <input id="search" class="admin-input search" placeholder="üîç Cari soalan atau kategori..." />
                <button id="refresh" class="btn ghost">üîÑ Refresh</button>
            </div>
        </div>

        <!-- Form Section -->
        <div id="formSection" style="display:none;">
            <h3 id="formTitle">Tambah FAQ</h3>
            <div class="admin-grid">
                <div class="form-row">
                    <div class="form-group">
                        <label>Soalan *</label>
                        <textarea id="question" class="admin-textarea" placeholder="Masukkan soalan di sini..."
                            style="min-height: 100px;"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Kategori</label>
                        <input id="category" class="admin-input" placeholder="Contoh: Umum, Pembayaran, Nisab" />
                    </div>
                </div>
                <div class="form-group">
                    <label>Jawapan *</label>
                    <textarea id="answer" class="admin-textarea" placeholder="Masukkan jawapan yang lengkap dan jelas..."
                        style="min-height: 150px;"></textarea>
                </div>
                <div id="formHint"></div>
                <div class="admin-actions">
                    <button id="cancelForm" class="btn ghost">‚úñÔ∏è Batal</button>
                    <button id="saveFaq" class="btn primary">üíæ Simpan</button>
                </div>
            </div>
        </div>

        <!-- Table Section -->
        <div class="admin-card">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width:80px;">ID</th>
                        <th>Soalan & Jawapan</th>
                        <th style="width:140px;">Kategori</th>
                        <th style="width:200px;">Tindakan</th>
                    </tr>
                </thead>
                <tbody id="faqTableBody"></tbody>
            </table>
            <div id="emptyState" style="display:none;">
                üì≠ Tiada rekod ditemui.
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ADMIN FAQ MANAGER - JAVASCRIPT
        // ============================================

        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            API_BASE: 'http://127.0.0.1:5000/admin/faqs',
            MIN_QUESTION_LENGTH: 10,
            MIN_ANSWER_LENGTH: 20,
            ANSWER_PREVIEW_LENGTH: 120
        };

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const DOM = {
            tbody: document.getElementById('faqTableBody'),
            emptyState: document.getElementById('emptyState'),
            searchInput: document.getElementById('search'),
            refreshBtn: document.getElementById('refresh'),
            newFaqBtn: document.getElementById('newFaqBtn'),
            formSection: document.getElementById('formSection'),
            formTitle: document.getElementById('formTitle'),
            questionInput: document.getElementById('question'),
            answerInput: document.getElementById('answer'),
            categoryInput: document.getElementById('category'),
            saveFaqBtn: document.getElementById('saveFaq'),
            cancelFormBtn: document.getElementById('cancelForm'),
            formHint: document.getElementById('formHint'),
            statusIndicator: document.getElementById('statusIndicator')
        };

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let STATE = {
            faqs: [],
            editingId: null,
            isLoading: false
        };

        // ============================================
        // FORM MANAGEMENT
        // ============================================
        const FormManager = {
            reset() {
                STATE.editingId = null;
                DOM.questionInput.value = '';
                DOM.answerInput.value = '';
                DOM.categoryInput.value = '';
                DOM.formHint.textContent = '';
                DOM.formHint.className = '';
            },

            show(isEdit = false, existing = null) {
                DOM.formTitle.textContent = isEdit ? '‚úèÔ∏è Kemaskini FAQ' : '‚ú® Tambah FAQ';
                if (isEdit && existing) {
                    DOM.questionInput.value = existing.question || '';
                    DOM.answerInput.value = existing.answer || '';
                    DOM.categoryInput.value = existing.category || '';
                    STATE.editingId = existing.id;
                }
                DOM.formSection.style.display = 'block';
                DOM.formHint.style.display = 'none';
                DOM.questionInput.focus();
            },

            hide() {
                DOM.formSection.style.display = 'none';
                this.reset();
            },

            validate() {
                const question = DOM.questionInput.value.trim();
                const answer = DOM.answerInput.value.trim();

                if (!question) {
                    UIManager.showMessage('‚ùå Sila masukkan soalan.', true);
                    DOM.questionInput.focus();
                    return false;
                }

                if (!answer) {
                    UIManager.showMessage('‚ùå Sila masukkan jawapan.', true);
                    DOM.answerInput.focus();
                    return false;
                }

                if (question.length < CONFIG.MIN_QUESTION_LENGTH) {
                    UIManager.showMessage(`‚ùå Soalan terlalu pendek. Sila masukkan sekurang-kurangnya ${CONFIG.MIN_QUESTION_LENGTH} aksara.`, true);
                    DOM.questionInput.focus();
                    return false;
                }

                if (answer.length < CONFIG.MIN_ANSWER_LENGTH) {
                    UIManager.showMessage(`‚ùå Jawapan terlalu pendek. Sila masukkan sekurang-kurangnya ${CONFIG.MIN_ANSWER_LENGTH} aksara.`, true);
                    DOM.answerInput.focus();
                    return false;
                }

                return true;
            },

            getFormData() {
                return {
                    question: DOM.questionInput.value.trim(),
                    answer: DOM.answerInput.value.trim(),
                    category: DOM.categoryInput.value.trim() || null
                };
            }
        };

        // ============================================
        // UI MANAGEMENT
        // ============================================
        const UIManager = {
            showLoading(show = true) {
                STATE.isLoading = show;
                DOM.saveFaqBtn.disabled = show;
                DOM.saveFaqBtn.innerHTML = show ? '‚è≥ Menyimpan...' : (STATE.editingId ? 'üíæ Kemaskini' : 'üíæ Simpan');
                DOM.refreshBtn.disabled = show;
                DOM.refreshBtn.innerHTML = show ? '‚è≥ Memuat...' : 'üîÑ Refresh';
            },

            updateStatus(message, isError = false) {
                DOM.statusIndicator.textContent = message;
                DOM.statusIndicator.style.color = isError ? '#e53e3e' : '#718096';
            },

            showMessage(message, isError = false) {
                DOM.formHint.textContent = message;
                DOM.formHint.className = isError ? 'error' : 'success';
                DOM.formHint.style.display = 'block';
            },

            escapeHtml(str) {
                return (str || '')
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;');
            },

            renderRows(items) {
                DOM.tbody.innerHTML = items.map(f => `
                    <tr>
                        <td><span class="id-badge">#${f.id}</span></td>
                        <td>
                            <div style="max-width: 500px;">
                                <div class="question-text">${this.escapeHtml(f.question)}</div>
                                <div class="answer-preview">
                                    ${this.escapeHtml(f.answer || '').substring(0, CONFIG.ANSWER_PREVIEW_LENGTH)}${f.answer && f.answer.length > CONFIG.ANSWER_PREVIEW_LENGTH ? '...' : ''}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="category-badge">
                                ${this.escapeHtml(f.category || 'Umum')}
                            </span>
                        </td>
                        <td>
                            <div class="admin-actions">
                                <button class="btn ghost" data-action="edit" data-id="${f.id}" title="Edit FAQ">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button class="btn warn" data-action="delete" data-id="${f.id}" title="Padam FAQ">
                                    üóëÔ∏è Padam
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                DOM.emptyState.style.display = items.length ? 'none' : 'block';
            }
        };

        // ============================================
        // SEARCH FUNCTIONALITY
        // ============================================
        const SearchManager = {
            apply() {
                const query = DOM.searchInput.value.toLowerCase().trim();
                if (!query) {
                    UIManager.renderRows(STATE.faqs);
                    return;
                }

                const filtered = STATE.faqs.filter(f =>
                    (f.question && f.question.toLowerCase().includes(query)) ||
                    (f.answer && f.answer.toLowerCase().includes(query)) ||
                    (f.category && f.category.toLowerCase().includes(query))
                );
                UIManager.renderRows(filtered);
            }
        };

        // ============================================
        // API SERVICE
        // ============================================
        const APIService = {
            async fetchFaqs() {
                const res = await fetch(CONFIG.API_BASE);
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                const data = await res.json();
                return data.faqs || [];
            },

            async createFaq(payload) {
                const res = await fetch(CONFIG.API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || `HTTP ${res.status}: ${res.statusText}`);
                }

                return await res.json();
            },

            async updateFaq(id, payload) {
                const res = await fetch(`${CONFIG.API_BASE}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || `HTTP ${res.status}: ${res.statusText}`);
                }

                return await res.json();
            },

            async deleteFaq(id) {
                const res = await fetch(`${CONFIG.API_BASE}/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || `HTTP ${res.status}: ${res.statusText}`);
                }

                return await res.json();
            }
        };

        // ============================================
        // FAQ OPERATIONS
        // ============================================
        const FAQOperations = {
            async load() {
                try {
                    UIManager.showLoading(true);
                    UIManager.updateStatus('‚è≥ Memuat FAQ...');

                    STATE.faqs = await APIService.fetchFaqs();
                    SearchManager.apply();

                    if (STATE.faqs.length === 0) {
                        UIManager.updateStatus('üìù Tiada FAQ ditemui. Klik "Soalan Baharu" untuk menambah FAQ pertama.');
                    } else {
                        UIManager.updateStatus(`‚úÖ ${STATE.faqs.length} FAQ ditemui`);
                    }
                } catch (error) {
                    console.error('Error loading FAQs:', error);
                    UIManager.updateStatus(`‚ùå Gagal memuat FAQ: ${error.message}`, true);
                    STATE.faqs = [];
                    SearchManager.apply();
                } finally {
                    UIManager.showLoading(false);
                }
            },

            async save() {
                if (STATE.isLoading || !FormManager.validate()) {
                    return;
                }

                const formData = FormManager.getFormData();

                try {
                    UIManager.showLoading(true);
                    UIManager.showMessage('‚è≥ Menyimpan FAQ...', false);

                    if (STATE.editingId) {
                        await APIService.updateFaq(STATE.editingId, formData);
                        UIManager.showMessage('‚úÖ FAQ berjaya dikemaskini!', false);
                    } else {
                        await APIService.createFaq(formData);
                        UIManager.showMessage('‚úÖ FAQ berjaya ditambah!', false);
                    }

                    await this.load();
                    setTimeout(() => FormManager.hide(), 1500);

                } catch (error) {
                    console.error('Save error:', error);
                    UIManager.showMessage(`‚ùå Gagal menyimpan: ${error.message}`, true);
                } finally {
                    UIManager.showLoading(false);
                }
            },

            async delete(id, question) {
                const confirmed = confirm(
                    `‚ö†Ô∏è Adakah anda pasti mahu memadam FAQ berikut?\n\n"${question}"\n\nTindakan ini tidak boleh dibatalkan.`
                );

                if (!confirmed) return;

                try {
                    UIManager.showLoading(true);
                    UIManager.updateStatus('‚è≥ Memadam FAQ...');

                    const result = await APIService.deleteFaq(id);
                    if (result.deleted) {
                        UIManager.updateStatus('‚úÖ FAQ berjaya dipadam!');
                        await this.load();
                    } else {
                        throw new Error('Gagal memadam FAQ');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    UIManager.updateStatus(`‚ùå Gagal memadam: ${error.message}`, true);
                } finally {
                    UIManager.showLoading(false);
                }
            }
        };

        // ============================================
        // EVENT HANDLERS
        // ============================================
        const EventHandlers = {
            init() {
                // New FAQ button
                DOM.newFaqBtn.addEventListener('click', () => {
                    FormManager.show(false);
                });

                // Cancel form button
                DOM.cancelFormBtn.addEventListener('click', () => {
                    FormManager.hide();
                });

                // Save FAQ button
                DOM.saveFaqBtn.addEventListener('click', () => {
                    FAQOperations.save();
                });

                // Table actions (Edit/Delete)
                DOM.tbody.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button');
                    if (!btn || STATE.isLoading) return;

                    const id = btn.getAttribute('data-id');
                    const action = btn.getAttribute('data-action');
                    const row = STATE.faqs.find(x => String(x.id) === String(id));

                    if (action === 'edit') {
                        FormManager.show(true, row);
                    } else if (action === 'delete') {
                        const question = row?.question || 'FAQ ini';
                        FAQOperations.delete(id, question);
                    }
                });

                // Search input
                DOM.searchInput.addEventListener('input', () => {
                    SearchManager.apply();
                });

                // Refresh button
                DOM.refreshBtn.addEventListener('click', () => {
                    FAQOperations.load();
                });
            }
        };

        // ============================================
        // APPLICATION INITIALIZATION
        // ============================================
        function init() {
            EventHandlers.init();
            FAQOperations.load();
        }

        // Start the application
        init();
    </script>
</body>

</html>