<!DOCTYPE html>
<html lang="ms">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZAKIA Chatbot - LZNK</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="chatbox" role="region" aria-label="ZAKIA Chatbot">
    <div class="header">
      <div class="header-left">
        <img src="zakia-avatar.png" class="avatar" alt="ZAKIA">
        <div class="header-text">
          <h3>ZAKIA</h3>
          <p>LZNK Chat Support</p>
        </div>
      </div>
      <button class="minimize-btn" title="Minimize">−</button>
    </div>

    <div class="end-chat-section">
      <button id="endChat" class="btn-end" title="End Chat">End Chat</button>
    </div>

    <div class="chat-container">
      <div class="date-indicator">
        <span class="date-chip">Today</span>
      </div>

      <div id="messages" class="messages" aria-live="polite" aria-relevant="additions">
        <div class="msg bot">
          <img src="zakia-avatar.png" class="msg-avatar" alt="ZAKIA">
          <div class="bubble bot-bubble">
            Assalamualaikum dan salam sejahtera! 👋 Saya Zakia, pembantu maya dari Lembaga Zakat Negeri Kedah (LZNK).
            Bagaimana saya boleh membantu anda hari ini? 😊
          </div>
        </div>
      </div>

      <div id="typing" class="typing hidden">
        <img src="zakia-avatar.png" class="msg-avatar" alt="ZAKIA">
        <div class="typing-bubble">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
      </div>

      <div id="quickReplies" class="quick-replies">
        <button class="quick-reply" data-text="Apa itu zakat?">Apa itu zakat?</button>
        <button class="quick-reply" data-text="Siapa yang wajib bayar zakat?">Siapa yang wajib bayar zakat?</button>
        <button class="quick-reply" data-text="Cara pembayaran zakat">Cara pembayaran zakat</button>
        <button class="quick-reply" data-text="Jenis zakat ada berapa?">Jenis zakat ada berapa?</button>
      </div>
    </div>

    <div class="input-area">
      <input type="text" id="userInput" placeholder="Tulis mesej anda…" autocomplete="off" />
      <button id="sendBtn" class="btn-send" aria-label="Hantar" title="Hantar">✈</button>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("userInput");
    const typingEl = document.getElementById("typing");
    const sendBtn = document.getElementById("sendBtn");
    const endBtn = document.getElementById("endChat");
    const quickRepliesEl = document.getElementById("quickReplies");

    let sessionId = null;
    let hasUserSentMessage = false;

    function appendMessage(text, sender) {
      const msg = document.createElement('div');
      msg.className = `msg ${sender}`;

      const now = new Date();
      const timeString = now.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });

      if (sender === 'bot') {
        msg.innerHTML = `
        <img src="zakia-avatar.png" class="msg-avatar" alt="ZAKIA">
        <div class="bubble-container">
          <div class="bubble bot-bubble">${escapeHtml(text)}</div>
          <div class="msg-time">${timeString}</div>
        </div>
      `;
      } else {
        msg.innerHTML = `
        <div class="bubble-container">
          <div class="bubble user-bubble">${escapeHtml(text)}</div>
          <div class="msg-time">${timeString}</div>
        </div>
      `;
      }

      messagesEl.appendChild(msg);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function setTyping(isTyping) {
      typingEl.classList.toggle('hidden', !isTyping);
    }

    function escapeHtml(str) {
      return str
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }

    function hideQuickReplies() {
      quickRepliesEl.style.display = 'none';
    }

    function showQuickReplies() {
      quickRepliesEl.style.display = 'flex';
    }

    async function sendMessage(messageOverride) {
      const text = (messageOverride ?? inputEl.value).trim();
      if (!text) return;

      appendMessage(text, 'user');
      inputEl.value = '';
      sendBtn.disabled = true;
      setTyping(true);
      hideQuickReplies();

      // Mark that user has sent their first message
      hasUserSentMessage = true;

      try {
        const requestBody = { message: text };
        if (sessionId) {
          requestBody.session_id = sessionId;
        }

        const res = await fetch("http://127.0.0.1:5000/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestBody)
        });

        const data = await res.json();

        if (data.session_id) {
          sessionId = data.session_id;
        }

        appendMessage(data.reply || 'Maaf, ralat pelayan. Cuba lagi. 🙏', 'bot');

        // Only show quick replies if user hasn't sent a message yet
        if (!hasUserSentMessage) {
          setTimeout(() => showQuickReplies(), 1000);
        }

      } catch (e) {
        appendMessage('Maaf, tidak dapat capai pelayan sekarang. Sila cuba lagi.', 'bot');
        // Only show quick replies if user hasn't sent a message yet
        if (!hasUserSentMessage) {
          showQuickReplies();
        }
      } finally {
        setTyping(false);
        sendBtn.disabled = false;
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }
    }

    // Events
    sendBtn.addEventListener('click', () => sendMessage());
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    quickRepliesEl.addEventListener('click', (e) => {
      const target = e.target;
      if (target.classList.contains('quick-reply')) {
        // Remove selected class from all quick replies
        document.querySelectorAll('.quick-reply').forEach(btn => {
          btn.classList.remove('selected');
        });

        // Add selected class to clicked button
        target.classList.add('selected');

        // Remove selected class after a short delay
        setTimeout(() => {
          target.classList.remove('selected');
        }, 2000);

        sendMessage(target.getAttribute('data-text'));
      }
    });

    endBtn.addEventListener('click', () => {
      messagesEl.innerHTML = '';
      sessionId = null;
      hasUserSentMessage = false; // Reset the flag when ending chat
      appendMessage('Sesi ditamatkan. Anda boleh mula semula bila-bila masa.', 'bot');
      showQuickReplies();
    });

    // Load FAQs for quick replies
    async function loadFAQs() {
      try {
        const res = await fetch("http://127.0.0.1:5000/faqs");
        const data = await res.json();

        if (data.faqs && data.faqs.length > 0) {
          const quickReplies = data.faqs.slice(0, 4); // Show first 4 FAQs
          quickRepliesEl.innerHTML = quickReplies.map(faq =>
            `<button class="quick-reply" data-text="${escapeHtml(faq.question)}">${escapeHtml(faq.question)}</button>`
          ).join('');
        }
      } catch (e) {
        console.log('Could not load FAQs:', e);
      }
    }

    // Initialize
    loadFAQs();
  </script>
</body>

</html>